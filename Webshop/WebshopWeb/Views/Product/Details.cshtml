@using Webshop.EntityFramework.Data
@model Products

@{
    ViewBag.Title = Model.ProductName;
}

<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="~/css/ProductDetails.css">
</head>

<h1 class="product-title">@Model.ProductName</h1>

<div class="product-container">

    <div class="product-image">
        @if (Model.ImageData != null && Model.ImageData.Length > 0)
        {
            var base64Image = Convert.ToBase64String(Model.ImageData);
            <img src="data:image/jpeg;base64,@base64Image" alt="@Model.ProductName">
        }
    </div>


    <div class="product-info">

        <p class="product-rating">
            <strong style="color:black">Átlagos értékelés:</strong>
            @if (Model.Reviews != null && Model.Reviews.Any())
            {
                var avgRating = Model.Reviews.Average(r => r.Rating);
                <span>@avgRating.ToString("0.0") csillag</span>

                <span style="color: gold;">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= avgRating)
                        {
                            <text>★</text>
                        }
                        else
                        {
                            <text>☆</text>
                        }
                    }
                </span>
            }
            else
            {
                <span style="color:black">Nincs értékelés.</span>
            }
        </p>

        <p class="product-price">@Model.Price.ToString("N0") Ft</p>
        <div id="cart-popup" class="popup">
            <div class="popup-content">
                <span id="popup-close" class="popup-close">&times;</span>
                <p id="popup-message">Product has been added to the cart!</p>
            </div>
        </div>

        <button id="add-to-cart-btn">Add to Cart</button>
        <script>
            const cartPopup = document.getElementById('cart-popup');
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            const closePopupBtn = document.getElementById('popup-close');

            function showPopup() {
              cartPopup.style.display = 'block';  
              setTimeout(() => {
                cartPopup.style.display = 'none';  
            }

            addToCartBtn.addEventListener('click', () => {

              showPopup();
            });

            closePopupBtn.addEventListener('click', () => {
              cartPopup.style.display = 'none';
            });

        </script>
        @if (Model.Quanity > 0)
        {
            <a href="@Url.Action("AddToCart","Product", new {ids = string.Join(",", Model.Id)})" class="add-to-cart"><button id="add-to-cart-btn">Kosárhoz adás</button></a>
        }
        else if (Model.Price == 0)
        {
            <p>Hamarosan</p>
        }
        else
        {
            <p>Nincs raktáron</p>
        }
    </div>
</div>

<div class="product-description">
    @foreach (var desc in Model.Description)
    {
        string[] line = desc.Split(':');
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-12 col-lg-2">
                    <p>@line[0]</p>
                </div>

                <div class="col-md-6 col-12 col-lg-2">
                    @if (line[1].ToLower().Contains("van"))
                    {
                        <p><img src="~/images/icons/check-mark.png" style="width:20px;height:20px;" /></p>
                    }
                    else if(line[1].ToLower().Contains("nincs"))
                    {
                        <p><img src="~/images/icons/close.png" style="width:20px;height:20px;" /></p>
                    }
                    else
                    {
                        <p>@line[1]</p>
                    }
                    
                </div>
            </div>
        </div>
    }
</div>


<h3>Értékelések</h3>
@if (Model.Reviews != null && Model.Reviews.Any())
{
    foreach (var review in Model.Reviews)
    {
        <div class="border p-2 mb-2">
            <strong>
                <span style="color: gold;">
                    @for (int i = 0; i < review.Rating; i++)
                    {
                        <text>★</text>
                    }
                    @for (int i = review.Rating; i < 5; i++)
                    {
                        <text>☆</text>
                    }
                </span>
            </strong>
            <p>@review.Comment</p>
            <small class="text-muted">Dátum: @review.CreatedAt.ToShortDateString()</small>
        </div>
    }
}
else
{
    <p>Még nincs értékelés.</p>
}

<h3>Új értékelés hozzáadása</h3>
<form asp-action="AddReview" asp-controller="Product" method="post">
    <input type="hidden" name="productId" value="@Model.Id" />

    <label>Értékelés (1-5):</label>
    <select name="rating" class="form-control" required>
        <option value="1">★☆☆☆☆</option>
        <option value="2">★★☆☆☆</option>
        <option value="3">★★★☆☆</option>
        <option value="4">★★★★☆</option>
        <option value="5">★★★★★</option>
    </select>

    <br />
    <label>Megjegyzés:</label>
    <textarea name="comment" class="form-control"></textarea>
    <br />
    <button type="submit" class="btn btn-primary">Értékelés beküldése</button>
</form>
